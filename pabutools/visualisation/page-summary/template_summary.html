<!--Priority TODOs: 
Deal with rejected projects
Fix tooltip for red bars
Fix highlight for red bars

Other TODOs:
Implement Comparisons
Implement Example
Maybe implement page description?


-->

<!DOCTYPE html>
<html translate="no">

<head>
    <!-- <title>!FILE!</title> -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src='sorttable.js'></script>
    <style>
        * {
            box-sizing: border-box;
            font-family: Roboto, system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            --ifm-table-cell-padding: 0.75rem;
            --ifm-table-background: #0000;
            --ifm-table-stripe-background: #00000008;
            --ifm-table-border-width: 1px;
            --ifm-table-border-color: #0000001f;
            --ifm-table-head-background: inherit;
            --ifm-table-head-color: inherit;
            --ifm-table-head-font-weight: 500;
            --ifm-table-cell-color: inherit;
        }

        body {
            font-family: "Helvetica-Neue", "Helvetica", Arial, sans-serif;
            font-size: 16px;
            padding: 5px 20px;
            line-height: 1.3;
            margin: 0 auto;
            max-width: 1300px;
        }

        table {
            border-collapse: collapse;
            display: block;
            margin-bottom: 1rem
        }

        table thead tr {
            border-bottom: 2px solid var(--ifm-table-border-color)
        }

        table thead,
        table tr:nth-child(2n) {
            background-color: var(--ifm-table-stripe-background)
        }

        table tr {
            background-color: var(--ifm-table-background);
            border-top: var(--ifm-table-border-width) solid var(--ifm-table-border-color)
        }

        table td,
        table th {
            border: var(--ifm-table-border-width) solid var(--ifm-table-border-color);
            padding: var(--ifm-table-cell-padding)
        }

        table th {
            background-color: var(--ifm-table-head-background);
            color: var(--ifm-table-head-color);
            font-weight: var(--ifm-table-head-font-weight)
        }

        table td {
            color: var(--ifm-table-cell-color)
        }

        table tr.winner td {
            background-color: rgb(113, 166, 91);
            color: #fff;
        }

        table tr.loser-first-phase td {
            background-color: rgb(240, 200, 200);
        }

        table tr.highlighted td {
            background-color: hsl(102, 30%, 70%);
            color: #000;
        }

        .chart-container {
            display: flex;
            flex-direction: column;
            margin: -10px 0;
        }

        .cost-locator-container {
            width: 300px;
            height: 11px;
            position: relative;
        }

        .cost-locator {
            position: absolute;
            top: 0;
            /* width: 15px; */
            padding: 0 5px;
            text-align: right;
            cursor: default;
            font-size: 10px;
            font-weight: 300;
            color: black;
            white-space: nowrap;
        }

        .chart {
            background: #fff;
            border: 0.5px solid #777;
            width: 300px;
            height: 15px;
            display: flex;
            align-items: center;
        }

        .bar {
            height: 100%;
            background: #00A000;
        }

        .final-bar{
            background: #aaa;
        }
        table tr.winner td .final-bar {
            background: #cee9cc;
        }

        .bar-blue {
            background: #83a8e6;
        }
        .bar-light {
            background: #f6c8c8;
        }
        .bar-dark {
            background: #dea0a0;
        }
    </style>
</head>

<body>
    <!-- <h1>!FILE!</h1> -->
    <!-- !DESCRIPTION! -->

    <!-- !SAMPLE_EXPLANATION1! -->
    </br>
    <!-- <table>
        <tbody>
            !SAMPLE_EXPLANATION_ROW!
        </tbody>
    </table> -->

    <!-- !SAMPLE_EXPLANATION2! -->

    <!-- Heading before table is displayed-->
    <h2>Results</h2>

    <p>[GOOGLE TRANSLATE] You can sort the table by clicking on the column against which you want to rank it.</p></br>

    <table class='sortable'>
        <thead>
        <tr>
        <th>Round</th>
        <th>ID</th>
        <th>Project Name</th>
        <th>Cost</th>
        <th>Number of Votes</th>
        <th>Effective Support</th>
        <th>Chart</th>
        </tr>
        </thead>
        <tbody>
            {% for round in rounds %}
                <tr class='winner' id='project-{{ round.id }}'>
                <td class='num' style='text-align:right' sorttable_customkey='{{ loop.index }}'> {{ loop.index }} </td>
                <td class='num' style='text-align:right' sorttable_customkey='{{ round.id }}'>{{ round.id }}</td>
                <td>{{ round.name }}</td>
                <td class='num' style='text-align:right' sorttable_customkey='{{ round.cost }}'>{{ round.cost }}</td>
                <td class='num' style='text-align:right' sorttable_customkey='{{ round.totalvotes }}'>{{ round.totalvotes }}</td>
                <td style='text-align:right' sorttable_customkey='{{ round.effective_vote_count[round.id] }}'>{{ round.effective_vote_count[round.id] }}</td>
                <td>
                    <div class='chart-container'>
                        <div class='cost-locator-container'>
                            <div class='cost-locator' 
                                style='left: calc({{ round.cost_percent }}&#37; - 9px);'
                                data-tippy-content='Project Cost: {{ round.cost }}'>
                                    <b>
                                        &darr; {{ round.cost }}
                                    </b>
                            </div>
                        </div>

                        <div class='chart'>
                            <div class='bar bar-blue'
                                style='width: {{ round.final_voter_funding_percent }}&#37;;'
                                data-tippy-content='&#10004; Supporters of the project have {{ round.final_voter_funding }} GBP, which is enough to cover the cost {{ round.cost }} GBP'>
                            </div>

                            <div class='bar bar-light'
                                onmouseover='highlight_project(["TODO"])'
                                onmouseout='unhighlight_project(["TODO"])'
                                style='width: {{ round.funding_lost_percent }}&#37;;'
                                data-tippy-content='<html lang=\"en\"><body>From the initial total funding, <b> {{ round.initial_voter_funding }} GBP </b> was spent on previously selected projects. </br> 
                                Most of the funding was spent on: TODO

                                <!-- For ...
                                        display_num++
                                        if display_num <= 3
                                            add to tooltip
                                            add to mouseover
                                            add to mouseout
                                -->
                                '
                                allowHTML: true>
                            </div>
                        </div>

                        <div class='cost-locator-container'>
                            <div class='cost-locator'
                                style='left: calc({{ round.initial_voter_funding_percent }}&#37; - 9px);'
                                data-tippy-content='Project initially has a funding of {{ round.initial_voter_funding }} GBP'>
                                <b>
                                    &uarr;
                                </b>
                                {{ round.initial_voter_funding }}
                            </div>
                        </div>
                    </div>                    
                </td>
            {% endfor %}
        </tbody>
    </table>

    </br></br>
    <!-- <h2>[GOOGLE TRANSLATE] Comparison of the method of equal shares with the greedy method</h2> -->

    <!-- <p>[GOOGLE TRANSLATE] We conducted an analysis comparing the equal shares method to the greedy method, which is the most frequently used method in citizen budgets. </p> -->

    <!-- !COMPARISON! -->

    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>
    <script>tippy('[data-tippy-content]', { allowHTML: true, maxWidth: 1000});

        function highlight_project(ids) {
            for (i = 0; i < ids.length; i++) {
                document.getElementById(ids[i]).classList.add('highlighted');
            }
        }
        function unhighlight_project(ids) {
            for (i = 0; i < ids.length; i++) {
                document.getElementById(ids[i]).classList.remove('highlighted');
            }
        }</script>
</body>

</html>





<!-- 
################################
########## BUILD HTML ##########
################################

template_filename = "template.html"
filename = "explanation.html"

with open(template_filename, "r") as f:
    template = f.read()

for project in e.profile:
    project_id = project.id
    if len(project.name) > 75:
        # Truncate the project name to 80 characters
        truncated_name = project.name[:72] + "..."
        project.name = truncated_name

max_votes = max([len(e.profile[c]) for c in e.profile])
MAX_SUPPORT = endowment * max_votes

def display_int(number):
    return f"{number:,}".replace(",", "&nbsp;")

def display_short_string(name):
    if len(name) <= short_string_length:
        return name
    res = " ".join(name[:short_string_length].split()[:-1])
    return res + "..."

def display_float(number):
    # use comma as decimal separator, \, for thousand separator
    return f"{number:.2f}".replace(".", ",")

def percent(num):
    return f"{80*num/MAX_SUPPORT:.1f}%"

def make_chart(project):
    global template
    global projects_order
    detailed_text_desc1 = ""
    detailed_text_desc2 = ""
    money_behind_candidate = money_behind_candidates[project]
    final_money_behind = money_behind_candidate[0]
    money_lost = []
    for i, candidate in enumerate(W_mes):
        # Rounds are numbered starting with 1.
        if i + 1 > projects_order[project]:
            break
        if len(money_behind_candidate) == i+1:
            break
        paid = money_behind_candidate[i] - money_behind_candidate[i+1]
        money_lost.append((candidate, paid))
        final_money_behind -= paid
    money_lost.reverse()
    html = []
    html.append("<div class='chart-container'>")
    html.append("<div class='cost-locator-container'>")
    tooltip = f"koszt projektu: {display_int(project.cost)} zł" # Text displayed while mouse is over top number
    # Text above the displayed example table row
    detailed_text_desc1 += f"""<h2> Wyjaśnienie diagramu dla przykładowego projektu (Projekt {project.name}) </h2>

                          <p>Koszt projektu {project.name} wynosił {display_int(project.cost)} zł (koszt ten jest oznaczony jako górna strzałka na diagramie). Projekt ten otrzymał {total_points[project]} głosów.
                          Ponieważ na każdego wyborcę przypada {int(endowment)} zł, zwolennikom projektu początkowo przysługuje kwota {display_int(int(money_behind_candidate[0]))} zł
                          (kwota ta jest oznaczona jako dolna strzałka na diagramie).</p>"""
    # Text below the displayed example table row (but before bulle points)
    detailed_text_desc2 += """<p>Kwota początkowo przysługująca tym wyborcom została częściowo przeznaczona na wcześniej wybrane projekty, na które ci wyborcy również zagłosowali: <ul> """
    detailed_text_desc3 = []
    # Div that displays location of project cost on the chart
    html.append(f"<div class='cost-locator' style='left: calc({percent(project.cost)} - 9px);' data-tippy-content='{tooltip}'><b>&darr; {display_int(project.cost)}</b></div>")
    html.append("</div>")

    # Div for the 3-coloured bar.
    html.append("<div class='chart'>")
    # Text shown on mouse-over for blue bar
    if final_money_behind >= project.cost:
        # When product has been funded
        tooltip = f"&#10004; zwolennikom projektu pozostało {display_int(int(final_money_behind))} zł, co wystarcza na pokrycie kosztu {display_int(project.cost)} zł"
        html.append(f"<div class='bar {'bar-blue'}' style='width: {percent(final_money_behind)};' data-tippy-content='{tooltip}'></div>")
    elif money_lost and final_money_behind < project.cost:
        # When project was originally funded but voters no longer have the required funds at this stage of the project
        tooltip = f"&#10008; po sfinansowaniu dotychczasowych projektów, zwolennikom tego projektu pozostało {display_int(int(final_money_behind))} zł, czyli mniej niż {display_int(project.cost)} zł"
        html.append(f"<div class='bar {'bar-blue'}' style='width: {percent(final_money_behind)};' data-tippy-content='{tooltip}'></div>")
    else:
        # Project did not recieve enough votes to be funded at any point in time
        tooltip = f"&#10008; zwolennikom projektu przysługuje jedynie {display_int(int(final_money_behind))} zł, czyli mniej niż {display_int(project.cost)} zł"
        html.append(f"<div class='bar {'bar-blue'}' style='width: {percent(final_money_behind)};' data-tippy-content='{tooltip}'></div>")

    # For red bar
    total_paid = sum([paid for _, paid in money_lost])
    # Sentence above bullet points displayed on red bar mouse-over
    tooltip_data = f"<html lang=\"en\"><body> Z początkowej kwoty wydano <b>{display_int(int(total_paid))} zł</b> na wcześniej wybrane projekty. </br> Najwięcej wydano na: <ul>"
    js_events_highlight = "onmouseover='highlight_project(["
    js_events_unhighlight = " onmouseout='unhighlight_project(["
    displayed_num = 0
    # For each project (list sorted by highest money taken from the row's voters)...
    for candidate, paid in sorted(money_lost, key=lambda item: item[1], reverse=True):
        displayed_num += 1
        # Max 3 projects displayed in tooltip
        if displayed_num <= max_project_num_dispayed_in_money_spent:
            # Adds bullet point to list displayed on red bar mouse-over
            tooltip_data += f" <li>Projekt {candidate.name} ({display_short_string(candidate.id)}): {display_int(int(paid))} zł. <hr style=\"width:{100 * paid/ total_paid}%;height:10px;color:#f6c8c8;background-color:#f6c8c8;text-align:left;margin-left:0\"></hr></li>"
            if displayed_num == 1:
                js_events_highlight += f"\"project-{candidate.name}\""
                js_events_unhighlight += f"\"project-{candidate.name}\""
            else:
                js_events_highlight += f",\"project-{candidate.name}\""
                js_events_unhighlight += f",\"project-{candidate.name}\""
        # Used for displayed example so that it can show ALL projects who have taken money from voters.
        detailed_text_desc3.append(f"<li>Projekt {candidate.name} ({display_short_string(candidate.id)}): wykorzystano na niego {display_int(int(paid))} zł. </li>")
    tooltip_data += "</ul></body></html>"
    js_events_highlight += "])'"
    js_events_unhighlight += "])'"
    # Combines all of the above into one piece of HTML code
    html.append(f"<div class='bar {'bar-light'}' {js_events_highlight} {js_events_unhighlight} style='width: {percent(total_paid)};' data-tippy-content='{tooltip_data}'; allowHTML: true></div>")

    # List of bullet points for example
    for row in detailed_text_desc3:
        detailed_text_desc2 += row

    # Text after bullet points in example
    detailed_text_desc2 += f"""</ul> <p> Całkowita kwota wykorzystana na wcześniej wybrane projekty jest zaznaczona jako różowy pasek na diagramie. Po najechaniu myszką pojawiają się informacje o najbardziej popularnych z tych projektów.</p>
                            <p> Ostatecznie wyborcom pozostało {display_int(int(final_money_behind))} zł. Kwota ta oznaczona jest jako niebieski pasek. Kwota ta jest mniejsza niż koszt projektu, dlatego projekt nie został wybrany."""
    
    # Add explanations for example to template
    if project.name == project_id_for_explanation:
        template = template.replace(
            "!SAMPLE_EXPLANATION1!",
            detailed_text_desc1
        )
        template = template.replace(
            "!SAMPLE_EXPLANATION2!",
            detailed_text_desc2
        )

    html.append("</div>")
    html.append("<div class='cost-locator-container'>")
    inital = int(money_behind_candidate[0])
    tooltip = f"zwolenikom projektu początkowo przysługuje {display_int(inital)} zł"
    html.append(f"<div class='cost-locator' style='left: calc({percent(inital)} - 9px);' data-tippy-content='{tooltip}'><b>&uarr;</b> {display_int(inital)}</div>")
    tooltip = f"zwolenikom projektu pozostało {display_int(int(final_money_behind))} zł"
    # html.append(f"<div class='cost-locator' style='left: calc({percent(final_money_behind)} - 9px);' data-tippy-content='{tooltip}'><b>&uarr;</b></div>")
    # html.append(f"<div class='cost-locator' style='left: calc({percent(final_money_behind)} - 50px);' data-tippy-content='{tooltip}'> {display_int(int(final_money_behind))}</div>")
    html.append("</div>")
    html.append("</div>")
    return "\n".join(html)


CHECKMARK = "&#10004;"

table = []
for project in projects_in_order:
    row = []
    if project in W_mes:
        row.append(f"<tr class='winner' id='project-{project.name}'>")
        row.append(f"<td class='num' style='text-align:right' sorttable_customkey='{projects_order[project]}'> {projects_order[project]} </td>")
        row.append(f"<td class='num' style='text-align:right' sorttable_customkey='{project.name}'>{project.name}</td>")
        row.append(f"<td>{project.id}</td>")
        row.append(f"<td class='num' style='text-align:right' sorttable_customkey='{project.cost}'>{display_int(project.cost)}</td>")
        row.append(f"<td class='num' style='text-align:right' sorttable_customkey='{total_points[project]}'>{display_int(total_points[project])}</td>")
        row.append(f"<td style='text-align:right' sorttable_customkey='{res[project]}'>{res[project]}%</td>")
        row.append(f"<td>{make_chart(project)}</td>")
    elif project not in W_first_phase_removed:
        row.append("<tr class='loser'>")
        row.append(f"<td class='num' style='text-align:right' sorttable_customkey='{len(e.profile) + 1}'>  &#10008; </td>")
        row.append(f"<td class='num' style='text-align:right' sorttable_customkey='{project.name}'>{project.name}</td>")
        row.append(f"<td>{project.id}</td>")
        row.append(f"<td class='num' style='text-align:right' sorttable_customkey='{project.cost}'>{display_int(project.cost)}</td>")
        row.append(f"<td class='num' style='text-align:right' sorttable_customkey='{total_points[project]}'>{display_int(total_points[project])}</td>")
        row.append(f"<td style='text-align:right' sorttable_customkey='{res[project]}'>{res[project]}%</td>")
        row.append(f"<td>{make_chart(project)}</td>")
    else:
        row.append("<tr class='loser-first-phase'>")
        row.append(f"<td class='num' style='text-align:right' sorttable_customkey='{len(e.profile) + 2}'>  &#10008; </td>")
        row.append(f"<td class='num' style='text-align:right' sorttable_customkey='{project.name}'>{project.name}</td>")
        row.append(f"<td>{project.id}</td>")
        row.append(f"<td class='num' style='text-align:right' sorttable_customkey='{project.cost}'>{display_int(project.cost)}</td>")
        row.append(f"<td class='num' style='text-align:right' sorttable_customkey='{total_points[project]}'>{display_int(total_points[project])}</td>")
        row.append(f"<td style='text-align:right' sorttable_customkey='0'></td>")
        row.append("<td>Odrzucony w pierwszej fazie.</td>")
    row.append("</tr>")
    if project.name == project_id_for_explanation:
        template = template.replace(
            "!SAMPLE_EXPLANATION_ROW!",
            "".join(row)
        )
    table += row
template = template.replace(
    "!ROWS!",
    "\n".join(table)
    )

template = template.replace(
    "!FILE!",
    "Wyniki Budżetu Obywatelskiego w Świeciu w 2024"
    )

# Description at top of page
description = f"""<p>W wyborach użyto <a href="https://equalshares.net/pl/">metody równych udziałów</a>. Dostępny budżet wynosił {display_int(initial_budget)} zł, a {display_int(len(e.voters))} mieszkańców oddało poprawny głos. Na każdego głosującego <b>przypadała zatem kwota około {display_int(int(initial_endowment))} zł</b>.
    Ze względu na naturę metody (<a href="https://equalshares.net/pl/implementation/completion">zainteresowanych odsyłamy do szczegółowego opisu</a>) kwota ta wzrosła <b>do {int(endowment)} zł</b>.
    Innymi słowy, każda grupa 100 wyborców mogła zdecydować o projekcie, którego koszt nie przekraczał {display_int(int(endowment * 100))}  zł.
    Spośród zgłoszonych projektów, {display_int(len(e.profile))} zweryfikowano pozytywnie od strony formalnej, z czego <b>{display_int(len(W_mes))} wybrano do realizacji</b>.</p>

    
    <p>Całkowity koszt wybranych projektów wynosi {display_int(total_cost)} zł. Poniżej przedstawiamy listę zgłoszonych projektów. Projekty, które zostały
    wybrane do realizacji zostały oznaczone na zielono. Projekty, które zostały odrzucone w pierwszej fazie oznaczono na czerwono. Są to projekty, które są zbyt drogie w stosunku
    do uzyskanej liczby głosów. (Liczba zwolenników dla takigo projektu podzielona przez liczbę wszystkich głosujących jest mniejsza niż koszt projektu podzielony przez trzykrotną wartość dostępnego budżetu.) </p>
     
    <p>Przy każdym projekcie podajemy jego koszt i liczbę głosów, które otrzymał. Ponadto, dla każdego projektu podajemy jego <b>efektywne poparcie</b>,
    które jest procentową wartością opisującą w jakim stopniu wielkość poparcia przekracza próg wymagany do akceptacji projektu:
    wartość powyżej 100% oznacza, że projekt został wybrany, a wartość poniżej 100% oznacza, że projekt nie został wybrany.
    Przykładowo, wartość efektywnego poparcia na poziomie 60% oznacza, że projekt otrzymał 60% głosów wymaganych do akceptacji. </p>

    Projekty mogły zostać niewybrane z jednego z następujących powodów:
    <ol>
    <li>projekt otrzymał zbyt mało głosów w stosunku do swojego kosztu, lub </li>
    <li>wyborcy, którzy głosowali na dany projekt głosowali również na inne bardziej popularne projekty, zatem ich głosy przełożyły się w pierwszej kolejności na sfinansowanie tych bardziej popularnych projektów. </li>
    </ol>
    
    <p>Przy każdym projekcie przedstawiamy również <b>diagram słupkowy</b>. Wyjaśnia on jaką kwotą zwolennicy każdego projektu początkowo dysponowali.
    Na diagramach możemy również zobaczyć, dlaczego dany projekt nie został wybrany. W szzcególności, możemy zobaczyć na które bardziej popularne projekty głosowali
    zwolennicy danego niewybranego projektu, oraz jaka część przysługujących im środków została przeznaczona na te bardziej popularne projekty. </p>
    """

template = template.replace(
    "!DESCRIPTION!",
    description
    )
    

comparison = f"""<p>  
    <ol>
    <li>W przypadku metody równych udziałów {display_float(excl_ratio(e, W_mes))}% wyborców nie otrzymało żadnego z projektów, na który zagłosowali. Gdyby użyć metody większościowej, to odsetek ten wynosiłby {display_float(excl_ratio(e, W_greedy))}%. </li>
    <li>W przypadku metody równych udziałów średnio dla wyborcy wybrano {display_float(avg_util(e, W_mes))} projektów spośród tych na które zagłosował. Gdyby użyć metody większościowej, to liczba ta wynosiłaby {display_float(avg_util(e, W_greedy))}.</li>
    </ol>
    """

template = template.replace(
    "!COMPARISON!",
    comparison
    )    


with open(filename, "w", encoding="utf-8") as f:
    f.write(template)
-->